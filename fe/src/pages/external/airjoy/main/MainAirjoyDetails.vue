<i18n lang="yaml">
en:
  online: "Online"
  offline: "Offline"
  groups: "Groups"
  devices: "Devices"
  details: "Details"
  filter_reset: "Filter Reset"
  power:
    on: "Power ON"
    off: "Power OFF"
  mode:
    auto: "Auto Mode"
    manual: "Manual Mode"
    unknown: "Unknown Mode"
  fan:
    normal: "Normal"
    weak: "Weak"
    medium: "Medium"
    high: "High"
    auto: "Auto"
    sleep: "Sleep"
    unknown: "Unknown"
  lock:
    lock: "Lock"
    unlock: "Unlock"
    unknown: "Unknown"
  sleep:
    awake: "Awake"
    sleep: "Sleep"
    unknown: "Unknown"
  timer:
    off: "Off"
    one: "1h"
    two: "2h"
    four: "4h"
    eight: "8h"
    unknown: "Unknown"
  uv:
    normal: "UV Normal"
    alarm: "UV Alarm"
  categories:
    pm10: "PM10: {0} μg/m³"
    pm2_5: "PM2.5: {0} μg/m³"
    co2: "CO2: {0} ppm"
    humidity: "Humidity: {0} %"
    temperature: "Temperature: {0} °C"
    voc: "VOC"
    service: "Service: {0}"
    filter_life: "Filter Life: {0}"
  labels:
    search: "You can filter by author or description."
    as_new: "New A/S"
    filter_reset: "Filter Reset"
    delete: "Delete a device"
  hints:
    description: "Detailed human-readable description."
    delete: "Please be careful! It cannot be recovered."
  headers:
    details: "Details"
  subheaders:
    details: "Details information for AIRJOY device"
  filter:
    normal: "Filter Normal"
    reset: "Filter Reset"
    exchange: "Filter Exchange"
    unknown: "Filter Unknown"
  tooltip:
    edit_name: "Edit AIRJOY device name"
    power:
      on: "Click the button to power off"
      off: "Click the button to power on"
    mode:
      auto: "Click the button to switch to manual mode"
      manual: " Click the button to switch to automatic mode"
    lock:
      lock: "Click the button to lock"
      unlock: "Click the button to unlock"
      unknown: "Unknown lock status"
    sleep:
      awake: "Click the button to sleep state"
      sleep: "Click the button to awake state"
      unknown: "Unknown sleep state"
    filter_reset: "Click the button to reset the remaining time of the filter"
    fan: "Click the button to change the fan speed."
    timer: "Click the button to set the timer"
    id: "AIRJOY device ID"
    fw: "Firmware version"
  time_unit:
    minutes: "{0}Minutes"
    hours : "{0}Hours"
    days: "{0}Days"
  filter_reset_confirm: "Are you sure? Are you really filter reset this device?"
  delete_confirm: "Are you sure? Are you really removing this device?"
  cancel: "Cancel"
  delete: "Delete"
  submit: "Submit"
  reset: "Reset"

ko:
  online: "네트워크 연결이 정상 상태 입니다"
  offline: "네트워크 연결이 끊어졌습니다"
  groups: "그룹"
  devices: "장치"
  details: "상세"
  filter_reset: "필터 리셋"
  power:
    on: "전원 켜짐"
    off: "전원 꺼짐"
  mode:
    auto: "자동 모드"
    manual: "수동 모드"
    unknown: "알수 없음"
  fan:
    normal: "팬"
    weak: "약"
    medium: "중"
    high: "강"
    auto: "자동"
    sleep: "잠자기"
    unknown: "알수 없음"
  lock:
    lock: "잠금 상태"
    unlock: "잠금 해제"
    unknown: "알수 없음"
  sleep:
    awake: "슬립 해제"
    sleep: "슬립 모드"
    unknown: "알수 없음"
  timer:
    off: "예약 없음"
    one: "1시간"
    two: "2시간"
    four: "4시간"
    eight: "8시간"
    unknown: "알수 없음"
  uv:
    normal: "UV 알람이 꺼져있습니다"
    alarm: "UV 알람이 켜져있습니다"
  categories:
    pm10: "미세먼지: {0} μg/m³"
    pm2_5: "초미세먼지: {0} μg/m³"
    co2: "이산화탄소: {0} ppm"
    humidity: "습도: {0} %"
    temperature: "온도: {0} °C"
    voc: "VOC"
    service: "서비스: {0}"
    filter_life: "필터 수명: {0}"
  labels:
    search: "담당자 또는 기록을 필터링할 수 있습니다."
    as_new: "새로운 A/S 기록"
    filter_reset: "필터 리셋"
    delete: "장치 제거"
  hints:
    description: "사람이 읽을 수 있는 상세한 설명."
    delete: "주의하세요! 이 명령은 되돌릴 수 없습니다!"
  headers:
    details: "상세 정보"
  subheaders:
    details: "AIRJOY 장치의 상세정보"
  filter:
    normal: "필터 정상"
    reset: "필터 시간 초기화"
    exchange: "필터 교체"
    unknown: "알수 없음"
  tooltip:
    edit_name: "AIRJOY 기기 이름을 수정합니다"
    power:
      on: "버튼을 클릭하여 전원을 끕니다"
      off: "버튼을 클릭하여 전원을 켭니다"
    mode:
      auto: "버튼을 클릭하여 수동 모드로 전환합니다"
      manual: "버튼을 클릭하여 자동 모드로 전환합니다"
    lock:
      lock: "버튼을 클릭하여 잠금을 해제합니다"
      unlock: "버튼을 클릭하여 잠급니다"
      unknown: "알 수 없는 잠금 상태 입니다"
    sleep:
      awake: "버튼을 클릭하여 잠자기 상태로 전환합니다"
      sleep: "버튼을 클릭하여 깨어납니다"
      unknown: "알 수 없는 슬립 상태"
    filter_reset: "버튼을 클릭하여 필터의 남은 시간을 초기화 합니다"
    fan: "버튼을 클릭하여 팬 속도를 조절할 수 있습니다"
    timer: "버튼을 클릭하여 타이머를 설정합니다"
    id: "AIRJOY 기기 ID"
    fw: "펌웨어 버전"
  time_unit:
    minutes: "{0}분"
    hours : "{0}시간"
    days: "{0}일"
  filter_reset_confirm: "필터 리셋을 진행합니까?"
  delete_confirm: "이 장치를 정말 제거합니까?"
  cancel: "취소"
  delete: "제거"
  submit: "제출"
  reset: "리셋"
</i18n>

<template>
  <v-container>
    <v-progress-linear
        height="2"
        absolute
        top
        color="primary"
        v-show="loading"
        :indeterminate="loading"
    ></v-progress-linear>

    <toolbar-breadcrumbs :items="breadcrumbs"></toolbar-breadcrumbs>
    <v-divider></v-divider>

    <v-row class="mt-2">
      <v-col class="d-flex flex-row align-center" cols="auto">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-btn
                class="mr-3"
                fab
                small
                elevation="0"
                :color="powerColor"
                v-bind="attrs"
                v-on="on"
                @click="onClickPower"
            >
              <v-icon>mdi-power</v-icon>
            </v-btn>
          </template>
          <span>{{ powerTooltip }}</span>
        </v-tooltip>

        <span v-if="!showEditNameDialog" class="text--primary text-h6 text-no-wrap">
          {{ item.name }}
        </span>
        <v-text-field
            v-else
            dense
            outlined
            hide-details
            autofocus
            v-model="editName"
            @change="onChangeEditName"
            @keydown.enter.stop="onChangeEditName"
            @keydown.esc.stop="onChangeEditNameCancel"
        ></v-text-field>
      </v-col>

      <v-spacer></v-spacer>

      <v-col cols="auto">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-btn
                class="mr-2"
                x-small
                plain
                icon
                @click="onClickEditName"
                v-bind="attrs"
                v-on="on"
            >
              <v-icon>mdi-pencil</v-icon>
            </v-btn>
          </template>
          <span>{{ $t('tooltip.edit_name') }}</span>
        </v-tooltip>

        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-icon
                class="mr-2"
                :color="uvLedColor"
                v-bind="attrs"
                v-on="on"
            >mdi-weather-sunny</v-icon>
          </template>
          <span>{{ uvLedDescription }}</span>
        </v-tooltip>

        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-icon
                class="mr-2"
                :color="onlineColor"
                v-bind="attrs"
                v-on="on"
            >{{ onlineIcon }}</v-icon>
          </template>
          <span>{{ onlineDescription }}</span>
        </v-tooltip>

        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-chip class="mr-2" outlined color="primary" v-bind="attrs" v-on="on">
              <v-icon left>mdi-identifier</v-icon>
              {{ item.uid }}
            </v-chip>
          </template>
          <span>{{ $t('tooltip.id') }}</span>
        </v-tooltip>

        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <v-chip v-bind="attrs" v-on="on">
              <v-icon left>mdi-tag</v-icon>
              {{ item.fw_ver }}
            </v-chip>
          </template>
          <span>{{ $t('tooltip.fw') }}</span>
        </v-tooltip>
      </v-col>
    </v-row>

    <v-divider class="mt-2"></v-divider>

    <v-row class="mt-2">
      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickPm10">
          <v-icon large>mdi-dots-hexagon</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.pm10', [item.pm10]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickPm2_5">
          <v-icon large>mdi-blur</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.pm2_5', [item.pm2_5]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickCo2">
          <v-icon large>mdi-molecule-co2</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.co2', [item.co2]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickHumidity">
          <v-icon large>mdi-water</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.humidity', [calcHumidityText(item.humidity)]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickTemperature">
          <v-icon large>mdi-thermometer</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.temperature', [calcTemperature(item.temperature)]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4" lg="2">
        <div v-ripple class="card" @click="onClickVoc">
          <span class="text--secondary text-h6 font-weight-bold text-no-wrap">
            {{ $t('categories.voc') }}
          </span>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ item.voc }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4">
        <div class="card">
          <v-icon large>{{ filterIcon }}</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ filterLabel }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="6" md="4">
        <div class="card">
          <v-icon large>mdi-timer-sand</v-icon>
          <span
              class="text--secondary text-subtitle-2 text-no-wrap"
              :class="filterLifeColor"
          >
            {{ $t('categories.filter_life', [filterLifeText]) }}
          </span>
        </div>
      </v-col>

      <v-col cols="12" sm="12" md="4">
        <div v-ripple class="card" @click="onClickService">
          <v-icon large>mdi-tools</v-icon>
          <span class="text--secondary text-subtitle-2 text-no-wrap">
            {{ $t('categories.service', [item.service_count]) }}
          </span>
        </div>
      </v-col>
    </v-row>

    <v-divider class="my-4"></v-divider>

    <v-row>
      <v-col cols="6" sm="4" md="2">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <div
                v-ripple
                class="card elevation-2"
                @click="onClickMode"
                v-bind="attrs"
                v-on="on"
            >
              <v-icon large>{{ modeIcon }}</v-icon>
              <span class="text--secondary text-subtitle-2 text-no-wrap">
                {{ modeLabel }}
              </span>
            </div>
          </template>
          <span>{{ modeTooltip }}</span>
        </v-tooltip>
      </v-col>

      <v-col cols="6" sm="4" md="2">
        <v-menu offset-y v-model="showFanMenu">
          <template v-slot:activator="{ on: menu, attrs }">
            <v-tooltip bottom>
              <template v-slot:activator="{ on: tooltip }">
                <div
                    v-ripple
                    class="card elevation-2"
                    v-bind="attrs"
                    v-on="{...tooltip, ...menu}"
                >
                  <v-icon large>{{ fanIcon }}</v-icon>
                  <span class="text--secondary text-subtitle-2 text-no-wrap">
                    {{ fanLabel }}
                  </span>
                </div>
              </template>
              <span>{{ $t('tooltip.fan') }}</span>
            </v-tooltip>
          </template>

          <airjoy-fan-speed-group
              @click:fan-weak="onClickFanWeak"
              @click:fan-medium="onClickFanMedium"
              @click:fan-high="onClickFanHigh"
          >
          </airjoy-fan-speed-group>
        </v-menu>
      </v-col>

      <v-col cols="6" sm="4" md="2">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <div
                v-ripple
                class="card elevation-2"
                @click="onClickLock"
                v-bind="attrs"
                v-on="on"
            >
              <v-icon large>{{ lockIcon }}</v-icon>
              <span class="text--secondary text-subtitle-2 text-no-wrap">
                {{ lockLabel }}
              </span>
            </div>
          </template>
          <span>{{ lockTooltip }}</span>
        </v-tooltip>
      </v-col>

      <v-col cols="6" sm="4" md="2">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <div
                v-ripple
                class="card elevation-2"
                @click="onClickFilterReset"
                v-bind="attrs"
                v-on="on"
            >
              <v-icon large>mdi-cached</v-icon>
              <span class="text--secondary text-subtitle-2 text-no-wrap">
                {{ $t('filter_reset') }}
              </span>
            </div>
          </template>
          <span>{{ $t('tooltip.filter_reset') }}</span>
        </v-tooltip>
      </v-col>

      <v-col cols="6" sm="4" md="2">
        <v-tooltip bottom>
          <template v-slot:activator="{ on, attrs }">
            <div
                v-ripple
                class="card elevation-2"
                @click="onClickSleep"
                v-bind="attrs"
                v-on="on"
            >
              <v-icon large>{{ sleepIcon }}</v-icon>
              <span class="text--secondary text-subtitle-2 text-no-wrap">
                {{ sleepLabel }}
              </span>
            </div>
          </template>
          <span>{{ sleepTooltip }}</span>
        </v-tooltip>
      </v-col>

      <v-col cols="6" sm="4" md="2">
        <v-menu offset-y v-model="showTimerMenu">
          <template v-slot:activator="{ on: menu, attrs }">
            <v-tooltip bottom>
              <template v-slot:activator="{ on: tooltip }">
                <div
                    v-ripple
                    class="card elevation-2"
                    v-bind="attrs"
                    v-on="{...tooltip, ...menu}"
                >
                  <v-icon large>{{ timerIcon }}</v-icon>
                  <span class="text--secondary text-subtitle-2 text-no-wrap">
                    {{ timerLabel }}
                  </span>
                </div>
              </template>
              <span>{{ $t('tooltip.timer') }}</span>
            </v-tooltip>
          </template>

          <airjoy-timer-group
              @click:timer-off="onClickTimerOff"
              @click:timer-one="onClickTimerOne"
              @click:timer-two="onClickTimerTwo"
              @click:timer-four="onClickTimerFour"
              @click:timer-eight="onClickTimerEight"
          ></airjoy-timer-group>
        </v-menu>
      </v-col>
    </v-row>

    <v-divider class="mt-4"></v-divider>
    <left-title
        :header="$t('headers.details')"
        :subheader="$t('subheaders.details')"
    >
      <v-form>
        <v-textarea
            filled
            auto-grow
            persistent-hint
            :value="description"
            @input="onInputDescription"
            :hint="$t('hints.description')"
        ></v-textarea>

        <v-row class="mt-2" no-gutters>
          <v-spacer></v-spacer>
          <v-btn
              class="mr-4"
              color="second"
              @click="onCancelDetails"
          >
            {{ $t('cancel') }}
          </v-btn>
          <v-btn
              color="primary"
              :loading="loadingSubmit"
              :disabled="disableSubmit"
              @click="onSubmitDetails"
          >
            {{ $t('submit') }}
          </v-btn>
        </v-row>
      </v-form>
    </left-title>

    <v-divider class="my-4"></v-divider>
    <v-alert outlined prominent type="error" class="ma-4">
      <v-row align="center" class="pl-4">
        <v-col>
          <v-row>
            <h6 class="text-h6">{{ $t('labels.delete') }}</h6>
          </v-row>
          <v-row>
            <span class="text-body-2">{{ $t('hints.delete') }}</span>
          </v-row>
        </v-col>
        <v-col class="shrink">
          <v-btn color="error" @click.stop="onClickDelete">
            {{ $t('delete') }}
          </v-btn>
        </v-col>
      </v-row>
    </v-alert>

    <!-- Delete dialog. -->
    <v-dialog v-model="showFilterResetDialog" :max-width="dialogMaxWidth">
      <v-card>
        <v-card-title class="text-h5 error--text">
          {{ $t('labels.filter_reset') }}
        </v-card-title>
        <v-card-text>
          {{ $t('filter_reset_confirm') }}
        </v-card-text>
        <v-divider></v-divider>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn @click="onClickFilterResetCancel">
            {{ $t('cancel') }}
          </v-btn>
          <v-btn
              color="error"
              @click="onClickFilterResetOk"
          >
            {{ $t('reset') }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- Delete dialog. -->
    <v-dialog v-model="showDeleteDialog" :max-width="dialogMaxWidth">
      <v-card>
        <v-card-title class="text-h5 error--text">
          {{ $t('labels.delete') }}
        </v-card-title>
        <v-card-text>
          {{ $t('delete_confirm') }}
        </v-card-text>
        <v-divider></v-divider>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn @click="onClickDeleteCancel">
            {{ $t('cancel') }}
          </v-btn>
          <v-btn
              color="error"
              :loading="loadingDelete"
              @click="onClickDeleteOk"
          >
            {{ $t('delete') }}
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

  </v-container>
</template>

<script lang="ts">
import {Component, Prop} from 'vue-property-decorator';
import VueBase from '@/base/VueBase';
import ToolbarBreadcrumbs from '@/components/ToolbarBreadcrumbs.vue';
import LeftTitle from '@/components/LeftTitle.vue';
import type {AirjoyControlQ, AirjoyUpdateDeviceQ} from '@/packet/airjoy';
import {
  CATEGORY_PM10,
  CATEGORY_PM2_5,
  CATEGORY_CO2,
  CATEGORY_HUMIDITY,
  CATEGORY_TEMPERATURE,
  CATEGORY_VOC,
  FILTER_STATUS_NORMAL,
  FILTER_STATUS_RESET,
  FILTER_STATUS_EXCHANGE,
  MODE_AUTO,
  MODE_MANUAL,
  FAN_CONTROL_NORMAL,
  FAN_CONTROL_WEAK,
  FAN_CONTROL_MEDIUM,
  FAN_CONTROL_HIGH,
  FAN_CONTROL_AUTO,
  FAN_CONTROL_SLEEP,
  UNLOCK,
  LOCK,
  AWAKE,
  SLEEP,
  POWER_STATE_OFF,
  POWER_STATE_ON,
  MINUTES_IN_DAY,
  createEmptyAirjoyDeviceA,
  calcHumidityText as _calcHumidityText,
  calcTemperature as _calcTemperature,
  calcFilterLifeMinutes, OFFLINE_CONVERSION_TIMEOUT_SECONDS,
} from '@/packet/airjoy';
import AirjoyFanSpeedGroup from '@/pages/external/airjoy/components/AirjoyFanSpeedGroup.vue';
import AirjoyTimerGroup from '@/pages/external/airjoy/components/AirjoyTimerGroup.vue';
import {createMoment, momentDurationSeconds} from "@/chrono/date";

export interface Control {
  mode?: number;
  power_state?: number;
  fan_control?: number;
  lock?: number;
  filter_reset?: number;
  sleep_mode?: number;
  time_reservation?: number;
}

@Component({
  components: {
    ToolbarBreadcrumbs,
    AirjoyFanSpeedGroup,
    AirjoyTimerGroup,
    LeftTitle,
  }
})
export default class MainAirjoyDetails extends VueBase {
  private readonly breadcrumbs = [
    {
      text: this.$t('groups'),
      disabled: false,
      href: () => this.moveToRootGroups(),
    },
    {
      text: this.$route.params.group,
      disabled: false,
      href: () => this.moveToGroup(),
    },
    {
      text: this.$route.params.project,
      disabled: false,
      href: () => this.moveToMain(),
    },
    {
      text: this.$t('devices'),
      disabled: false,
      href: () => this.moveToMainAirjoyDevices(),
    },
    {
      text: this.$t('details'),
      disabled: true,
    },
    {
      text: this.$route.params.device,
      disabled: true,
    },
  ];

  @Prop({type: Number, default: 320})
  readonly dialogMaxWidth!: number;

  @Prop({type: Number, default: 1000})
  readonly updateIntervalMilliseconds!: number;

  @Prop({type: Boolean, default: true})
  readonly onlyFilterUnitDays!: boolean;

  loading = false;
  item = createEmptyAirjoyDeviceA();

  showFanMenu = false;
  showTimerMenu = false;

  intervalHandle = -1;

  showFilterResetDialog = false;
  loadingFilterReset = false;

  showDeleteDialog = false;
  loadingDelete = false;

  loadingSubmit = false;
  originalDescription = '';
  description = '';

  showEditNameDialog = false;
  editName = '';

  created() {
    this.updateDevice(true);
  }

  mounted() {
    this.intervalHandle = window.setInterval(() => {
      this.updateDevice();
    }, this.updateIntervalMilliseconds);
  }

  beforeDestroy() {
    window.clearInterval(this.intervalHandle);
  }

  updateDevice(firstLoading?: boolean) {
    this.loading = true;
    const group = this.$route.params.group;
    const project = this.$route.params.project;
    const device = this.$route.params.device;
    this.$api2.getAirjoyDevice(group, project, device)
        .then(item => {
          this.loading = false;
          this.item = item;
          if (firstLoading) {
            this.originalDescription = item.description;
            this.description = item.description;
          }
        })
        .catch(error => {
          this.loading = false;
          this.toastRequestFailure(error);
        });
  }

  calcHumidityText(value: number) {
    return _calcHumidityText(value)
  }

  calcTemperature(value: number) {
    return _calcTemperature(value);
  }

  get modifiedDescription() {
    return this.description !== this.originalDescription;
  }

  get disableSubmit() {
    return !this.modifiedDescription || this.loadingSubmit;
  }

  get filterColor() {
    switch (this.item.filter) {
      case FILTER_STATUS_NORMAL:
        return '';  // 'light-green darken-4';
      case FILTER_STATUS_RESET:
        return 'yellow darken-4';
      case FILTER_STATUS_EXCHANGE:
        return 'red';
      default:
        return 'blue-grey';
    }
  }

  get filterIcon() {
    switch (this.item.filter) {
      case FILTER_STATUS_NORMAL:
        return 'mdi-air-filter';
      case FILTER_STATUS_RESET:
        return 'mdi-alarm';
      case FILTER_STATUS_EXCHANGE:
        return 'mdi-cached';
      default:
        return 'mdi-help';
    }
  }

  get filterLabel() {
    switch (this.item.filter) {
      case FILTER_STATUS_NORMAL:
        return this.$t('filter.normal');
      case FILTER_STATUS_RESET:
        return this.$t('filter.reset');
      case FILTER_STATUS_EXCHANGE:
        return this.$t('filter.exchange');
      default:
        return this.$t('filter.unknown');
    }
  }

  get filterLifeColor() {
    if (this.item.filter_life == 0) {
      return 'red--text text--darken-3';
    } else {
      return '';
    }
  }

  get filterLifeText() {
    const minutes = calcFilterLifeMinutes(this.item.filter_life);
    if (!this.onlyFilterUnitDays) {
      if (minutes < 60) {
        return this.$t('time_unit.minutes', [minutes])
      }
      if (minutes < (60 * 24)) {
        return this.$t('time_unit.hours', [Math.ceil(minutes / 60)])
      }
    }
    return this.$t('time_unit.days', [Math.ceil(minutes / MINUTES_IN_DAY)])
  }

  get powerColor() {
    if (this.item.power_state) {
      return 'green';
    } else {
      return 'red';
    }
  }

  get powerTooltip() {
    if (this.item.power_state) {
      return this.$t('tooltip.power.on');
    } else {
      return this.$t('tooltip.power.off');
    }
  }

  get modeIcon() {
    switch (this.item.mode) {
      case MODE_MANUAL:
        return 'mdi-alpha-m-circle-outline';
      case MODE_AUTO:
        return 'mdi-alpha-a-circle-outline';
      default:
        return 'mdi-help-circle-outline';
    }
  }

  get modeLabel() {
    switch (this.item.mode) {
      case MODE_MANUAL:
        return this.$t('mode.manual');
      case MODE_AUTO:
        return this.$t('mode.auto');
      default:
        return this.$t('mode.unknown');
    }
  }

  get modeTooltip() {
    if (this.item.mode) {
      return this.$t('tooltip.mode.auto');
    } else {
      return this.$t('tooltip.mode.manual');
    }
  }

  get fanIcon() {
    switch (this.item.fan_control) {
      case FAN_CONTROL_NORMAL:
        return 'mdi-fan';
      case FAN_CONTROL_WEAK:
        return 'mdi-fan-speed-1';
      case FAN_CONTROL_MEDIUM:
        return 'mdi-fan-speed-2';
      case FAN_CONTROL_HIGH:
        return 'mdi-fan-speed-3';
      case FAN_CONTROL_AUTO:
        return 'mdi-fan-auto';
      case FAN_CONTROL_SLEEP:
        return 'mdi-fan-off';
      default:
        return 'mdi-fan';
    }
  }

  get fanLabel() {
    switch (this.item.fan_control) {
      case FAN_CONTROL_NORMAL:
        return this.$t('fan.normal');
      case FAN_CONTROL_WEAK:
        return this.$t('fan.weak');
      case FAN_CONTROL_MEDIUM:
        return this.$t('fan.medium');
      case FAN_CONTROL_HIGH:
        return this.$t('fan.high');
      case FAN_CONTROL_AUTO:
        return this.$t('fan.auto');
      case FAN_CONTROL_SLEEP:
        return this.$t('fan.sleep');
      default:
        return this.$t('fan.unknown');
    }
  }

  get lockIcon() {
    switch (this.item.lock) {
      case LOCK:
        return 'mdi-lock';
      case UNLOCK:
        return 'mdi-lock-open-variant';
      default:
        return 'mdi-lock-alert';
    }
  }

  get lockLabel() {
    switch (this.item.lock) {
      case LOCK:
        return this.$t('lock.lock');
      case UNLOCK:
        return this.$t('lock.unlock');
      default:
        return this.$t('lock.unknown');
    }
  }

  get lockTooltip() {
    switch (this.item.lock) {
      case LOCK:
        return this.$t('tooltip.lock.lock');
      case UNLOCK:
        return this.$t('tooltip.lock.unlock');
      default:
        return this.$t('tooltip.lock.unknown');
    }
  }

  get sleepIcon() {
    switch (this.item.sleep_mode) {
      case AWAKE:
        return 'mdi-sleep-off';
      case SLEEP:
        return 'mdi-sleep';
      default:
        return 'mdi-help';
    }
  }

  get sleepLabel() {
    switch (this.item.sleep_mode) {
      case AWAKE:
        return this.$t('sleep.awake');
      case SLEEP:
        return this.$t('sleep.sleep');
      default:
        return this.$t('sleep.unknown');
    }
  }

  get sleepTooltip() {
    switch (this.item.sleep_mode) {
      case AWAKE:
        return this.$t('tooltip.sleep.awake');
      case SLEEP:
        return this.$t('tooltip.sleep.sleep');
      default:
        return this.$t('tooltip.sleep.unknown');
    }
  }

  get timerIcon() {
    switch (this.item.time_reservation) {
      case 0:
        return 'mdi-timer-off-outline';
      case 1:
        return 'mdi-clock-time-one-outline';
      case 2:
        return 'mdi-clock-time-two-outline';
      case 3:
        return 'mdi-clock-time-four-outline';
      case 4:
        return 'mdi-clock-time-eight-outline';
      default:
        return 'mdi-help';
    }
  }

  get timerLabel() {
    const time = this.item.time_reservation || 0;
    switch (time) {
      case 0:
        return this.$t('timer.off');
      case 1:
        return this.$t('timer.one');
      case 2:
        return this.$t('timer.two');
      case 3:
        return this.$t('timer.four');
      case 4:
        return this.$t('timer.eight');
      default:
        return this.$t('timer.unknown');
    }
  }

  isOnline() {
    if (this.item.online) {
      return true;
    }

    const now = createMoment();
    const time = createMoment(this.item.time);
    const durationSeconds = momentDurationSeconds(now, time);
    return durationSeconds <= OFFLINE_CONVERSION_TIMEOUT_SECONDS;
  }

  get onlineColor() {
    if (this.isOnline()) {
      return 'green';
    } else {
      return 'red';
    }
  }

  get onlineIcon() {
    if (this.isOnline()) {
      return 'mdi-lan-connect';
    } else {
      return 'mdi-lan-disconnect';
    }
  }

  get onlineDescription() {
    if (this.isOnline()) {
      return this.$t('online');
    } else {
      return this.$t('offline');
    }
  }

  get uvLedColor() {
    if (this.item.uv_led) {
      return 'grey';
    } else {
      return 'orange';
    }
  }

  get uvLedDescription() {
    if (this.item.uv_led) {
      return this.$t('uv.normal');
    } else {
      return this.$t('uv.alarm');
    }
  }

  controlDevice(state: Control) {
    const group = this.$route.params.group;
    const project = this.$route.params.project;
    const device = this.$route.params.device;
    this.loading = true;
    const body = {
      uid: Number.parseInt(device),
      mode: state.mode ?? this.item.mode,
      power_state: state.power_state ?? this.item.power_state,
      fan_control: state.fan_control ?? this.item.fan_control,
      lock: state.lock ?? this.item.lock,
      filter_reset: state.filter_reset ?? 0,
      sleep_mode: state.sleep_mode ?? this.item.sleep_mode,
      time_reservation: state.time_reservation ?? this.item.time_reservation,
    } as AirjoyControlQ;
    this.$api2.postAirjoyControl(group, project, device, body)
        .then(() => {
          this.loading = false;
          this.toastRequestSuccess();
          this.updateDevice();
        })
        .catch(error => {
          this.loading = false;
          this.toastRequestFailure(error);
        });
  }

  onInputDescription(value) {
    this.description = value || '';
  }

  onCancelDetails() {
    this.description = this.originalDescription;
  }

  onSubmitDetails() {
    const group = this.$route.params.group;
    const project = this.$route.params.project;
    const device = this.$route.params.device;
    const name = this.item.name;
    const description = this.description;
    const body = {
      name: name,
      description: description,
    } as AirjoyUpdateDeviceQ;
    this.loadingSubmit = true;
    this.$api2.patchAirjoyDevice(group, project, device, body)
        .then(() => {
          this.loadingSubmit = false;
          this.toastRequestSuccess();
          this.originalDescription = description;
        })
        .catch(error => {
          this.loadingSubmit = false;
          this.toastRequestFailure(error);
        });
  }

  onClickPower() {
    let power_state;
    if (this.item.power_state == POWER_STATE_ON) {
      power_state = POWER_STATE_OFF;
    } else {
      power_state = POWER_STATE_ON;
    }
    this.controlDevice({power_state: power_state});
  }

  onClickEditName() {
    this.editName = this.item.name;
    this.showEditNameDialog = !this.showEditNameDialog;
  }

  onChangeEditName() {
    if (!this.showEditNameDialog) {
      return;
    }

    this.showEditNameDialog = false;
    if (this.editName === this.item.name) {
      return;
    }

    const group = this.$route.params.group;
    const project = this.$route.params.project;
    const device = this.$route.params.device;
    const body = {
      name: this.editName,
      description: this.originalDescription,
    } as AirjoyUpdateDeviceQ;

    this.$api2.patchAirjoyDevice(group, project, device, body)
        .then(() => {
          this.item.name = this.editName;
          this.toastRequestSuccess();
        })
        .catch(error => {
          this.toastRequestFailure(error);
        });
  }

  onChangeEditNameCancel() {
    this.showEditNameDialog = false;
  }

  onClickPm10() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_PM10);
  }

  onClickPm2_5() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_PM2_5);
  }

  onClickCo2() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_CO2);
  }

  onClickHumidity() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_HUMIDITY);
  }

  onClickTemperature() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_TEMPERATURE);
  }

  onClickVoc() {
    this.moveToMainAirjoyChart(`${this.item.uid}`, CATEGORY_VOC);
  }

  onClickMode() {
    let mode;
    if (this.item.mode == MODE_AUTO) {
      mode = MODE_MANUAL;
    } else {
      mode = MODE_AUTO;
    }
    this.controlDevice({mode: mode});
  }

  onClickService() {
    this.moveToMainAirjoyService(`${this.item.uid}`);
  }

  onClickFanWeak() {
    this.showFanMenu = false;
    this.controlDevice({fan_control: FAN_CONTROL_WEAK});
  }

  onClickFanMedium() {
    this.showFanMenu = false;
    this.controlDevice({fan_control: FAN_CONTROL_MEDIUM});
  }

  onClickFanHigh() {
    this.showFanMenu = false;
    this.controlDevice({fan_control: FAN_CONTROL_HIGH});
  }

  onClickLock() {
    let lock;
    if (this.item.lock == LOCK) {
      lock = UNLOCK;
    } else {
      lock = LOCK;
    }
    this.controlDevice({lock: lock});
  }

  onClickFilterReset() {
    this.showFilterResetDialog = true;
  }

  onClickFilterResetCancel() {
    this.showFilterResetDialog = false;
  }

  onClickFilterResetOk() {
    this.showFilterResetDialog = false;
    this.controlDevice({filter_reset: 1});
  }

  onClickSleep() {
    let sleep_mode;
    if (this.item.sleep_mode == SLEEP) {
      sleep_mode = AWAKE;
    } else {
      sleep_mode = SLEEP;
    }
    this.controlDevice({sleep_mode: sleep_mode});
  }

  onClickTimerOff() {
    this.showTimerMenu = false;
    this.controlDevice({time_reservation: 0});
  }

  onClickTimerOne() {
    this.showTimerMenu = false;
    this.controlDevice({time_reservation: 1});
  }

  onClickTimerTwo() {
    this.showTimerMenu = false;
    this.controlDevice({time_reservation: 2});
  }

  onClickTimerFour() {
    this.showTimerMenu = false;
    this.controlDevice({time_reservation: 3});
  }

  onClickTimerEight() {
    this.showTimerMenu = false;
    this.controlDevice({time_reservation: 4});
  }

  onClickDelete() {
    this.showDeleteDialog = true;
  }

  onClickDeleteCancel() {
    this.showDeleteDialog = false;
  }

  onClickDeleteOk() {
    this.loadingDelete = true;
    const group = this.$route.params.group;
    const project = this.$route.params.project;
    const device = this.$route.params.device;
    this.$api2.deleteAirjoyDevice(group, project, device)
        .then(() => {
          this.showDeleteDialog = false;
          this.loadingDelete = false;
          this.moveToMainAirjoyDevices();
          this.toastRequestSuccess();
        })
        .catch(error => {
          this.loadingDelete = false;
          this.toastRequestFailure(error);
        });
  }
}
</script>

<style lang="scss" scoped>
@import '~vuetify/src/styles/styles.sass';

.card {
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  justify-content: center;
  align-content: center;
  align-items: center;

  height: 120px;

  padding: 24px;
  border-radius: 12px;
  border-style: solid;
  border-width: 1px;

  cursor: pointer;
}

.theme--light.v-application .card {
  border-color: rgba(map-get($shades, 'black'), 0.2);
}

.theme--dark.v-application .card {
  border-color: rgba(map-get($shades, 'white'), 0.2);
}

.v-menu__content {
  box-shadow: none;
}
</style>
